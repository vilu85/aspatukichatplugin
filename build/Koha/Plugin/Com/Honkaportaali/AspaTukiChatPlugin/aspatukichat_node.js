var payload,lastTimestamp,prog,error,motd,isChatVisible=!1;$.getScript("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/pageslide/jquery.pageslide.min.js",(function(){$.get("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/nodechat.html",(function(e){$("#changelanguage").before(e),$(document).ready((function(){$((function(){var e=["#e21400","#91580f","#f8a700","#f78b00","#58dc00","#287b00","#a8f07a","#4ae8c4","#3b88eb","#3824aa","#a700ff","#d300e7"],a=$(window),t=$(".loggedinusername").html(),s=$(".chat-box"),n=$("#txtMessage"),o=$(".login.page"),i=$(".chat.page");const r=document.querySelector("#chatusers"),l=document.querySelector("#chatmodal");var u,d,c=$(".loggedinusername").html(),m=!1,p=!1;$("#i18nMenu").after('<ul class="nav nav-tabs navbar-nav navbar navbar-right">           <li><button id="chatBtn" class="btn" type="button"><i class="fa fa-comments"></i><span id="unreadMsgs" class="badge"></span></button>           </li></ul>');var g=io.connect("http://kohabox:80",{path:"/chat/socket.io"});$("#chatmodal").on("shown.bs.modal",(function(){$.cookie("isChatOpen",1),0,$("#txtMessage").focus()})),$("#chatmodal").on("hidden.bs.modal",(function(){$.removeCookie("isChatOpen")}));const h=new Set,y=e=>{var a="";1===e.numUsers?a+="Keskustelussa on 1 osallistuja":a+="Keskustelussa on  "+e.numUsers+" osallistujaa",f(a)},v=()=>{(c=k(t.trim()))&&(o.fadeOut(),i.show(),o.off("click"),d=n.focus(),g.emit("add user",c))},f=(e,a)=>{var t=$("<li>").addClass("log").text(e);x(t,a)},b=(e,a)=>{var t=C(e);a=a||{},0!==t.length&&(a.fade=!1,t.remove());var s=$('<div class="media w-100 mb-3"/>'),n=$('<div class="media-left"/>'),o=$('<img class="img-thumbnail media-object" src="assets/img/user.svg" width="50px" />'),i=$('<p class="media-object text-center text-muted"/>').text(e.username).css("color",M(e.username)),r=$('<div class="media-body"/>'),l=$('<div class="bg-light shadow-sm rounded px-3 mb-1 padding-6"/>'),u=$("<p>").text(e.message);const d=A(new Date);var m,p=$('<p class="text-muted mx-8"/>').text(d),g=$('<div class="media w-100 ml-auto mb-3"/>'),h=$('<div class="bg-primary shadow rounded"/>'),y=$('<p class="mb-0 text-white padding-6">').text(e.message);$('<p class="text-muted">').text(d);if(e.typing){var v=$('<span class="username"/>').text(e.username).css("color",M(e.username)),f=$('<span class="messageBody">').text(e.message),b=e.typing?"typing":"";m=e.typing?$('<li class="message"/>').data("username",e.username).addClass(b).append(v,f):""}else m=e.username!=c?s.append(n.append(o,i),r.append(l.append(u),p)):g.append(r.append(h.append(y),p));x(m,a)},w=e=>{C(e).fadeOut((function(){$(this).remove()}))},x=(e,a)=>{var t=$(e);a||(a={}),void 0===a.fade&&(a.fade=!0),void 0===a.prepend&&(a.prepend=!1),a.fade&&t.hide().fadeIn(150),a.prepend?s.prepend(t):s.append(t),s[0].scrollTop=s[0].scrollHeight},k=e=>$("<div/>").text(e).html(),C=e=>$(".typing.message").filter((function(a){return $(this).data("username")===e.username})),M=a=>{for(var t=7,s=0;s<a.length;s++)t=a.charCodeAt(s)+(t<<5)-t;var n=Math.abs(t%e.length);return e[n]};function A(e){var a=e,t=new Date,s=new Date(Date.now()-864e5),n=a.getFullYear(),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.getMonth()],i=a.getDate(),r=a.getHours(),l=a.getMinutes();return a.setHours(0,0,0,0)==t.setHours(0,0,0,0)?"today, "+r+":"+l:a.setHours(0,0,0,0)==s.setHours(0,0,0,0)?"yesterday, "+r+":"+l:n==t.getFullYear()?i+" "+o+", "+r+":"+l:i+" "+o+" "+n+", "+r+":"+l}a.keydown((e=>{var a;e.ctrlKey||e.metaKey||e.altKey||d.focus(),13===e.which&&(c?(a=n.val(),(a=k(a))&&m&&(n.val(""),b({username:c,message:a}),g.emit("new message",a)),g.emit("stop typing"),p=!1):v())})),n.on("input",(()=>{m&&(p||(p=!0,g.emit("typing")),u=(new Date).getTime(),setTimeout((()=>{(new Date).getTime()-u>=400&&p&&(g.emit("stop typing"),p=!1)}),400))})),o.click((()=>{d.focus()})),n.click((()=>{n.focus()})),g.on("login",(e=>{m=!0;f("AspaTukiChat â€“ ",{prepend:!0}),y(e)})),g.on("new message",(e=>{var a;b(e),H(l)||($("#unreadMsgs").text(a))})),g.on("user joined",(e=>{f(e.username+" liittyi"),e.activeUsers.map((e=>{h.add(e)})),(e=>{if(!r||document.querySelector(`#${e.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry`))return;const a=`<li id="${e.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry" class="list-group-item"><span>${e}</span></li>`;r.innerHTML+=a})(e.username),y(e)})),g.on("user left",(e=>{var a;f(e.username+" poistui"),y(e),w(e),a=e.username,r&&!document.querySelector(`#${a.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry`)||document.querySelector(`#${a.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry`).remove()})),g.on("typing",(e=>{(e=>{e.typing=!0,e.message="kirjoittaa...",b(e)})(e)})),g.on("stop typing",(e=>{w(e)})),g.on("disconnect",(()=>{f("yhteys katkaistu")})),g.on("reconnect",(()=>{f("yhteys muodostettu uudelleen"),c&&g.emit("add user",c)})),g.on("reconnect_error",(()=>{f("yhteyden muodostaminen uudelleen ei onnistunut")})),g.on("new server message",(e=>{console.log("data: %s",e);var a={username:"System",message:e.data};b(a)}));const H=e=>"null"!=e.css("display")&&"none"!=e.css("display");$(document).ready((function(){c&&(v(),$("#chatBtn").click((()=>{(isChatVisible=!isChatVisible)?$("#chatmodal").fadeIn():$("#chatmodal").fadeOut()})))}))}))}))}))}));