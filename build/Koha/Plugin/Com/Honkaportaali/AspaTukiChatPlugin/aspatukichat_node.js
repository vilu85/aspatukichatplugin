var payload,lastTimestamp,prog,error,motd,isChatVisible=!1;$.getScript("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/pageslide/jquery.pageslide.min.js",(function(){$.get("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/nodechat.html",(function(e){$("#changelanguage").before(e),$(document).ready((function(){$((function(){var e=["#e21400","#91580f","#f8a700","#f78b00","#58dc00","#287b00","#a8f07a","#4ae8c4","#3b88eb","#3824aa","#a700ff","#d300e7"],a=$(window),t=$(".loggedinusername").html(),n=$(".chat-box"),s=$("#txtMessage"),o=$(".login.page"),i=$(".chat.page");const r=document.querySelector(".inbox__people");var d,c,l=$(".loggedinusername").html(),u=!1,p=!1;$("#i18nMenu").after('<ul class="nav nav-tabs navbar-nav navbar navbar-right">   <li><button id="chatBtn" class="btn btn-primary dropdown-toggle dropdown" type="button">Support&nbsp;<span id="unreadMsgs" class="badge"></span><span class="caret"></span></button>   </li></ul>');var m=io.connect("http://kohabox:80",{path:"/chat/socket.io"});$("#chatmodal").on("shown.bs.modal",(function(){$.cookie("isChatOpen",1),$("#txtMessage").focus()})),$("#chatmodal").on("hidden.bs.modal",(function(){$.removeCookie("isChatOpen")}));const g=new Set,h=e=>{var a="";1===e.numUsers?a+="there's 1 participant":a+="there are "+e.numUsers+" participants",f(a)},v=()=>{(l=x(t.trim()))&&(o.fadeOut(),i.show(),o.off("click"),c=s.focus(),m.emit("add user",l))},f=(e,a)=>{var t=$("<li>").addClass("log").text(e);w(t,a)},b=(e,a)=>{var t=k(e);a=a||{},0!==t.length&&(a.fade=!1,t.remove());var n=$('<div class="media w-100 mb-3"/>'),s=$('<div class="media-left"/>'),o=$('<img class="img-circle media-object" src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" width="50px" />'),i=$('<p class="media-object text-center text-muted"/>').text(e.username).css("color",C(e.username)),r=$('<div class="media-body"/>'),d=$('<div class="bg-light shadow-sm rounded px-3 mb-1 padding-6"/>'),c=$("<p>").text(e.message);const u=M(new Date);var p,m=$('<p class="text-muted mx-8"/>').text(u),g=$('<div class="media w-100 ml-auto mb-3"/>'),h=$('<div class="bg-primary shadow rounded"/>'),v=$('<p class="mb-0 text-white padding-6">').text(e.message);$('<p class="text-muted">').text(u);if(e.typing){var f=$('<span class="username"/>').text(e.username).css("color",C(e.username)),b=$('<span class="messageBody">').text(e.message),y=e.typing?"typing":"";p=e.typing?$('<li class="message"/>').data("username",e.username).addClass(y).append(f,b):""}else p=e.username!=l?n.append(s.append(o,i),r.append(d.append(c),m)):g.append(r.append(h.append(v),m));w(p,a)},y=e=>{k(e).fadeOut((function(){$(this).remove()}))},w=(e,a)=>{var t=$(e);a||(a={}),void 0===a.fade&&(a.fade=!0),void 0===a.prepend&&(a.prepend=!1),a.fade&&t.hide().fadeIn(150),a.prepend?n.prepend(t):n.append(t),n[0].scrollTop=n[0].scrollHeight},x=e=>$("<div/>").text(e).html(),k=e=>$(".typing.message").filter((function(a){return $(this).data("username")===e.username})),C=a=>{for(var t=7,n=0;n<a.length;n++)t=a.charCodeAt(n)+(t<<5)-t;var s=Math.abs(t%e.length);return e[s]};function M(e){var a=e,t=new Date,n=new Date(Date.now()-864e5),s=a.getFullYear(),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.getMonth()],i=a.getDate(),r=a.getHours(),d=a.getMinutes();return a.setHours(0,0,0,0)==t.setHours(0,0,0,0)?"today, "+r+":"+d:a.setHours(0,0,0,0)==n.setHours(0,0,0,0)?"yesterday, "+r+":"+d:s==t.getFullYear()?i+" "+o+", "+r+":"+d:i+" "+o+" "+s+", "+r+":"+d}a.keydown((e=>{var a;e.ctrlKey||e.metaKey||e.altKey||c.focus(),13===e.which&&(l?(a=s.val(),(a=x(a))&&u&&(s.val(""),b({username:l,message:a}),m.emit("new message",a)),m.emit("stop typing"),p=!1):v())})),s.on("input",(()=>{u&&(p||(p=!0,m.emit("typing")),d=(new Date).getTime(),setTimeout((()=>{(new Date).getTime()-d>=400&&p&&(m.emit("stop typing"),p=!1)}),400))})),o.click((()=>{c.focus()})),s.click((()=>{s.focus()})),m.on("login",(e=>{u=!0;f("AspaTukiChat â€“ ",{prepend:!0}),h(e)})),m.on("new message",(e=>{b(e)})),m.on("user joined",(e=>{f(e.username+" joined"),e.activeUsers.map((e=>{g.add(e)})),(e=>{if(!r||document.querySelector(`.${e}-userlist`))return;const a=`\n      <div class="chat_ib ${e}-userlist">\n        <h5>${e}</h5>\n      </div>\n    `;r.innerHTML+=a})(e.username),h(e)})),m.on("user left",(e=>{var a;f(e.username+" left"),h(e),y(e),a=e.username,r&&!document.querySelector(`.${a}-userlist`)||document.querySelector(`.${a}-userlist`).remove()})),m.on("typing",(e=>{(e=>{e.typing=!0,e.message="is typing",b(e)})(e)})),m.on("stop typing",(e=>{y(e)})),m.on("disconnect",(()=>{f("you have been disconnected")})),m.on("reconnect",(()=>{f("you have been reconnected"),l&&m.emit("add user",l)})),m.on("reconnect_error",(()=>{f("attempt to reconnect has failed")})),m.on("new server message",(e=>{console.log("data: %s",e);var a={username:"System",message:e.data};b(a)})),$(document).ready((function(){l&&(v(),$("#chatBtn").click((()=>{(isChatVisible=!isChatVisible)?$("#chatmodal").fadeIn():$("#chatmodal").fadeOut()})))}))}))}))}))}));