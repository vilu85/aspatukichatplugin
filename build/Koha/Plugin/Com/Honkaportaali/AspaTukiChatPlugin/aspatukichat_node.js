var payload,lastTimestamp,prog,error,motd,isChatVisible=!1;$.getScript("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/pageslide/jquery.pageslide.min.js",(function(){$.get("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/nodechat.html",(function(e){$("#changelanguage").before(e),$(document).ready((function(){$((function(){var e=["#e21400","#91580f","#f8a700","#f78b00","#58dc00","#287b00","#a8f07a","#4ae8c4","#3b88eb","#3824aa","#a700ff","#d300e7"],a=$(window),t=$(".loggedinusername").html(),s=$(".chat-box"),n=$("#txtMessage"),o=$(".login.page"),i=$(".chat.page");const r=document.querySelector("#chatusers");$("#chatmodal");var l,u,c=$(".loggedinusername").html(),d=!1,m=!1;$("#i18nMenu").after('<ul class="nav nav-tabs navbar-nav navbar navbar-right">           <li><button id="chatBtn" class="btn" type="button"><i class="fa fa-comments"></i><span id="unreadMsgs" class="badge"></span></button>           </li></ul>');var p=io.connect("http://lainaamo-intra.ouka.fi",{path:"/chat/socket.io"});$("#chatmodal").on("shown.bs.modal",(function(){$.cookie("isChatOpen",1),0,$("#txtMessage").focus()})),$("#chatmodal").on("hidden.bs.modal",(function(){$.removeCookie("isChatOpen")}));const g=new Set,h=e=>{var a="";1===e.numUsers?a+="Keskustelussa on 1 osallistuja":a+="Keskustelussa on  "+e.numUsers+" osallistujaa",v(a)},f=()=>{(c=k(t.trim()))&&(o.fadeOut(),i.show(),o.off("click"),u=n.focus(),p.emit("add user",c))},v=(e,a)=>{var t=$("<li>").addClass("log").text(e);w(t,a)},y=(e,a)=>{var t=x(e);a=a||{},0!==t.length&&(a.fade=!1,t.remove());var s=$('<div class="media w-100 mb-3"/>'),n=$('<div class="media-left"/>'),o=$('<img class="img-thumbnail media-object" src="/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/user.svg" width="50px" />'),i=$('<p class="media-object text-center text-muted"/>').text(e.username).css("color",C(e.username)),r=$('<div class="media-body"/>'),l=$('<div class="bg-light shadow-sm rounded px-3 mb-1 padding-6"/>'),u=$("<p>").text(e.message);const d=M(new Date);var m,p=$('<p class="text-muted mx-8"/>').text(d),g=$('<div class="media w-100 ml-auto mb-3"/>'),h=$('<div class="bg-primary shadow rounded"/>'),f=$('<p class="mb-0 text-white padding-6">').text(e.message);$('<p class="text-muted">').text(d);if(e.typing){var v=$('<span class="username"/>').text(e.username).css("color",C(e.username)),y=$('<span class="messageBody">').text(e.message),b=e.typing?"typing":"";m=e.typing?$('<li class="message"/>').data("username",e.username).addClass(b).append(v,y):""}else m=e.username!=c?s.append(n.append(o,i),r.append(l.append(u),p)):g.append(r.append(h.append(f),p));w(m,a)},b=e=>{x(e).fadeOut((function(){$(this).remove()}))},w=(e,a)=>{var t=$(e);a||(a={}),void 0===a.fade&&(a.fade=!0),void 0===a.prepend&&(a.prepend=!1),a.fade&&t.hide().fadeIn(150),a.prepend?s.prepend(t):s.append(t),s[0].scrollTop=s[0].scrollHeight},k=e=>$("<div/>").text(e).html(),x=e=>$(".typing.message").filter((function(a){return $(this).data("username")===e.username})),C=a=>{for(var t=7,s=0;s<a.length;s++)t=a.charCodeAt(s)+(t<<5)-t;var n=Math.abs(t%e.length);return e[n]};function M(e){var a=e,t=new Date,s=new Date(Date.now()-864e5),n=a.getFullYear(),o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.getMonth()],i=a.getDate(),r=a.getHours(),l=a.getMinutes();return a.setHours(0,0,0,0)==t.setHours(0,0,0,0)?"tänään, "+r+":"+l:a.setHours(0,0,0,0)==s.setHours(0,0,0,0)?"eilen, "+r+":"+l:n==t.getFullYear()?i+" "+o+", "+r+":"+l:i+" "+o+" "+n+", "+r+":"+l}a.keydown((e=>{var a;e.ctrlKey||e.metaKey||e.altKey||u.focus(),13===e.which&&(c?(a=n.val(),(a=k(a))&&d&&(n.val(""),y({username:c,message:a}),p.emit("new message",a)),p.emit("stop typing"),m=!1):f())})),n.on("input",(()=>{d&&(m||(m=!0,p.emit("typing")),l=(new Date).getTime(),setTimeout((()=>{(new Date).getTime()-l>=400&&m&&(p.emit("stop typing"),m=!1)}),400))})),o.click((()=>{u.focus()})),n.click((()=>{n.focus()})),p.on("login",(e=>{d=!0;v("AspaTukiChat – ",{prepend:!0}),h(e)})),p.on("new message",(e=>{var a;y(e),A($("#chatModal"))||(document.querySelector("#unreadMsgs").innerText=a)})),p.on("user joined",(e=>{v(e.username+" liittyi"),e.activeUsers.map((e=>{g.add(e)})),(e=>{if(!r||document.querySelector(`#${e.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry`))return;const a=`<li id="${e.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry" class="list-group-item"><span>${e}</span></li>`;r.innerHTML+=a})(e.username),h(e)})),p.on("user left",(e=>{var a;v(e.username+" poistui"),h(e),b(e),a=e.username,r&&!document.querySelector(`#${a.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry`)||document.querySelector(`#${a.trim().replaceAll(" ","").toLocaleLowerCase()}-userentry`).remove()})),p.on("typing",(e=>{(e=>{e.typing=!0,e.message="kirjoittaa...",y(e)})(e)})),p.on("stop typing",(e=>{b(e)})),p.on("disconnect",(()=>{v("yhteys katkaistu")})),p.on("reconnect",(()=>{v("yhteys muodostettu uudelleen"),c&&p.emit("add user",c)})),p.on("reconnect_error",(()=>{v("yhteyden muodostaminen uudelleen ei onnistunut")})),p.on("new server message",(e=>{console.log("data: %s",e);var a={username:"System",message:e.data};y(a)}));const A=e=>(console.log("isElementVisible check"),"null"!=e.css("display")&&"none"!=e.css("display"));$(document).ready((function(){c&&(f(),$("#chatBtn").click((()=>{(isChatVisible=!isChatVisible)?$("#chatmodal").fadeIn():$("#chatmodal").fadeOut()})))}))}))}))}))}));