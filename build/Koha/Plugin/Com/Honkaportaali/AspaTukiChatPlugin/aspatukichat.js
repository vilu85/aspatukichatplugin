var payload,lastTimestamp,prog,error,motd,useNode=!0;function send_and_show(e,a,s,t){showLoading(e),send_data(a,s,(function(){hideLoading(),t()}))}function send_data(e,a,s){var t={};t.userdata=JSON.stringify(e),t.class="Koha::Plugin::Com::Honkaportaali::AspaTukiChatPlugin",t.method="tool",t.sub=a,$.ajax({type:"POST",url:"/cgi-bin/koha/plugins/run.pl",data:t,success:s,dataType:"json"})}function onLogin(e){if("authok"==e.status)payload={username:$(".loggedinusername").html()},$.cookie("chatUser",payload.username),showLoading("Opening chat"),motd=e.data,send_data(payload,"get_initial_data",onInitialDataReceived);else{if(hideLoading(),console.log("AspaTukiChat logon failed: "+e),$.removeCookie("chatUser"),"offline"==e.status){var a='<div id="offline" class="text-error">        <h4>Chat system is offline</h4>        <p>'+e.data+"</p>      </div>";$("#loadingAnim").after(a)}if("authfail"==e.status){$("#loadingAnim").after('<div id="offline" class="text-error">        <h4>Login failed</h4>        <p>This may be because</p>        <ul>          <li>Your credentials were not accepted</li>          <li>You don\'t have sufficient rights to access this module</li>        </ul>      </div>')}}}function onInitialDataReceived(e){if(hideLoading(),payload=e,lastTimestamp=e.timestamp,e.messagesjson&&(lastTimestamp=e.timestamp,e.messagesjson.forEach(handleMessage)),""!=motd){var a="<p>"+motd+"</p>";$("#chatmessages").append(a)}asyncGetMessages()}function asyncGetMessages(){send_data(payload={username:$(".loggedinusername").html(),timestamp:lastTimestamp},"get_last_messages",(function(e){e.messagesjson&&(lastTimestamp=e.timestamp,$.cookie("chatTimestamp",e.timestamp),$.cookie("chatMessages",e.messagesjson),e.messagesjson.forEach(handleMessage)),asyncGetMessages()}))}function handleMessage(e,a,s){e.isOwn?addNewMessage(e.id,e.content,e.timestamp,e.diff):addNewMessageFrom(e.id,e.from,e.content,e.timestamp,e.diff),$("#chatmessages").scrollTop(9999)}function addNewMessageFrom(e,a,s,t,o){var n=getExtraStyle(o),i=getExtraJs(e,o),d='<div class="media w-100 mb-3" id="message_'+e+'" '+n+'>     <div class="media-left"><a><img class="img-circle media-object" src="https://res.cloudinary.com/mhmd/image/upload/v1564960395/avatar_usae7z.svg" width="50px" /><p class="media-object text-center text-muted">'+a+'</p></a></div>     <div class="media-body">         <div class="bg-light shadow-sm rounded px-3 mb-1 padding-6">             <p>'+s+'</p>         </div>         <p class="text-muted mx-8">'+timeConverter(t)+"</p>     </div> </div>"+i;$("#chatmessages").append(d)}function addNewMessage(e,a,s,t){var o=getExtraStyle(t),n=getExtraJs(e,t),i='<div class="media w-100 ml-auto mb-3" id="message_'+e+'" '+o+'>                         <div class="media-body">                             <div class="bg-primary shadow rounded">                                 <p class="mb-0 text-white padding-6">'+a+'</p>                             </div>                             <p class="text-muted">'+timeConverter(s)+"</p>                         </div>                     </div>"+n;$("#chatmessages").append(i)}function getExtraStyle(e){return e<7?'style="display:none;"':""}function getExtraJs(e,a){return a<7?"<script>$('#message_"+e+"').slideToggle('slow');<\/script>":""}function handle_chat_submit(){payload.username=$(".loggedinusername").html(),payload.message=$("#txtMessage").val(),$("#txtMessage").val(""),null!=payload.message&&""!=payload.message.trim()&&(send_data(payload,"new_message",onMessageSent),$("#txtMessage").focus())}function onMessageSent(e){2==e.success&&e.messagesjson?console.log("onMessageSent success"):(console.log("onMessageSent failed: "),console.log(e.success),console.log(e.messagesjson))}function showLoading(e){$("#loadingMsg").html(e+"..."),$("#loadingAnim").show()}function hideLoading(){$("#loadingAnim").hide()}function updateUnreadMsgs(e){$("#unreadMsgs").text(e)}function timeConverter(e){var a=new Date(1e3*e),s=new Date,t=new Date(Date.now()-864e5),o=a.getFullYear(),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.getMonth()],i=a.getDate(),d=a.getHours(),l=a.getMinutes();return a.setHours(0,0,0,0)==s.setHours(0,0,0,0)?"today, "+d+":"+l:a.setHours(0,0,0,0)==t.setHours(0,0,0,0)?"yesterday, "+d+":"+l:o==s.getFullYear()?i+" "+n+", "+d+":"+l:i+" "+n+" "+o+", "+d+":"+l}$("#i18nMenu").after('<ul class="nav nav-tabs navbar-nav navbar navbar-right">     <li><button class="btn btn-primary dropdown-toggle dropdown" type="button" data-target="#chatmodal" data-toggle="modal">Support&nbsp;<span id="unreadMsgs" class="badge"></span><span class="caret"></span></button> </li></ul>'),$("#chatmodal").on("shown.bs.modal",(function(){$.cookie("isChatOpen",1),$("#txtMessage").focus()})),$("#chatmodal").on("hidden.bs.modal",(function(){$.removeCookie("isChatOpen")})),$.getScript("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/pageslide/jquery.pageslide.min.js",(function(){useNode?$.get("/chat/index.html",(function(e){$("#changelanguage").before(e),$(document).ready((function(){$("#chatmodal").on("shown.bs.modal",(function(){$.cookie("isChatOpen",1),$("#txtMessage").focus()})),$("#chatmodal").on("hidden.bs.modal",(function(){$.removeCookie("isChatOpen")})),$("#chat_page_submit").click(handle_chat_submit),$("#txtMessage").keypress((function(e){"13"==(e.keyCode?e.keyCode:e.which)&&handle_chat_submit(),e.stopPropagation()})),payload={username:$(".loggedinusername").html()},1==$.cookie("isChatOpen")&&$("#chatmodal").modal()}))})):$.get("/plugin/Koha/Plugin/Com/Honkaportaali/AspaTukiChatPlugin/chat2.html",(function(e){$("#changelanguage").before(e),$(document).ready((function(){$("#chatmodal").on("shown.bs.modal",(function(){$.cookie("isChatOpen",1),$("#txtMessage").focus()})),$("#chatmodal").on("hidden.bs.modal",(function(){$.removeCookie("isChatOpen")})),$("#chat_page_submit").click(handle_chat_submit),$("#txtMessage").keypress((function(e){"13"==(e.keyCode?e.keyCode:e.which)&&handle_chat_submit(),e.stopPropagation()})),payload={username:$(".loggedinusername").html()},1==$.cookie("isChatOpen")&&$("#chatmodal").modal(),showLoading("Logging in"),send_data(payload,"login",onLogin)}))}))}));